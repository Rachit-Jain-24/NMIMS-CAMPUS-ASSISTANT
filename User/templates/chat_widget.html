<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NMIMS Campus Assistant</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Base styles */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            /* Use Flask's url_for to get the correct static path for the background image */
            background-image: url("{{ url_for('static', filename='media/background.jpg') }}");
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }

        /* Custom scrollbar for the chat messages area */
        #nmims-chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        #nmims-chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        #nmims-chat-messages::-webkit-scrollbar-thumb {
            background: #D2232A; /* NMIMS Red */
            border-radius: 10px;
        }
        #nmims-chat-messages::-webkit-scrollbar-thumb:hover {
            background: #a81c22; /* Darker NMIMS Red */
        }
        
        /* --- NEW: Style for Language Select --- */
        #nmims-lang-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22currentColor%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%3E%3Cpolyline%20points%3D%226%209%2012%2015%2018%209%22%3E%3C%2Fpolyline%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.25em;
            padding-right: 2rem; /* Make space for the icon */
        }
        
        /* --- NEW: Style for Mic Button animation --- */
        .mic-active {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(210, 35, 42, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(210, 35, 42, 0); }
            100% { box-shadow: 0 0 0 0 rgba(210, 35, 42, 0); }
        }

    </style>
</head>
<body class="h-full">

    <button 
        id="nmims-chat-button" 
        class="fixed bottom-5 right-5 w-16 h-16 bg-[#D2232A] rounded-full shadow-lg flex items-center justify-center text-white cursor-pointer transform transition-all duration-300 hover:scale-105 hover:bg-[#a81c22] focus:outline-none focus:ring-4 focus:ring-red-300" 
        role="button" 
        tabindex="0"
        aria-label="Open NMIMS help chat"
    >
        <svg id="nmims-button-icon" class="w-8 h-8" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
        </svg>
        <img id="nmims-button-logo" src="" alt="Chat" class="w-10 h-10 rounded-full object-cover hidden" />
    </button>

    <div 
        id="nmims-chat-overlay" 
        class="fixed inset-0 bg-black bg-opacity-50 z-40 items-center justify-center hidden" 
        role="dialog" 
        aria-modal="true" 
        aria-hidden="true"
        aria-labelledby="nmims-chat-title"
    >
        <div class="nmims-chat-modal flex flex-col w-full h-full sm:w-[500px] sm:h-auto sm:max-h-[90vh] bg-white sm:rounded-xl shadow-2xl overflow-hidden animate-slide-up">
            
            <div class="nmims-chat-header flex items-center justify-between p-4 bg-[#D2232A] text-white flex-shrink-0">
                <div class="flex items-center gap-3">
                    <img id="nmims-header-logo" src="" alt="NMIMS Logo" class="w-10 h-10 rounded-full bg-white p-1" />
                    <div>
                        <div id="nmims-chat-title" class="font-bold text-lg leading-tight">NMIMS Campus Assistant</div>
                        <div class="text-sm text-red-100 leading-tight">Your Smart Companion</div>
                    </div>
                </div>
                
                <div class="flex items-center gap-2">
                    <select id="nmims-lang-select" class="text-sm bg-white text-gray-800 font-medium py-1 px-2 rounded-md cursor-pointer outline-none focus:ring-2 focus:ring-white">
                        <option value="en">English</option>
                        <option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)</option>
                        <option value="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å (Telugu)</option>
                    </select>
                    <button 
                        id="nmims-chat-close" 
                        class="nmims-chat-close text-3xl text-red-200 hover:text-white transition-colors" 
                        aria-label="Close chat"
                    >
                        &times;
                    </button>
                </div>
            </div>

            <div id="nmims-chat-messages" class="nmims-chat-messages flex-1 overflow-y-auto p-5 space-y-4 bg-gray-50 min-h-[300px]">
                </div>

            <div class="nmims-chat-input-area p-4 bg-white border-t border-gray-200">
                <div class="nmims-chat-input-container flex items-end gap-3">
                    <textarea 
                        id="nmims-chat-input" 
                        class="nmims-chat-input flex-1 p-3 border border-gray-300 rounded-2xl resize-none outline-none focus:ring-2 focus:ring-[#D2232A] focus:border-transparent transition-all"
                        placeholder="Ask me anything about campus..."
                        rows="1"
                        aria-label="Message input"
                    ></textarea>
                    
                    <button 
                        id="nmims-chat-mic" 
                        class="nmims-chat-mic w-11 h-11 bg-gray-200 text-gray-700 rounded-full flex items-center justify-center flex-shrink-0 transition-all duration-300 hover:bg-gray-300"
                        aria-label="Start voice input"
                    >
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1.2-9.1c0-.66.54-1.2 1.2-1.2.66 0 1.2.54 1.2 1.2l-.01 6.2c0 .66-.53 1.2-1.19 1.2-.66 0-1.2-.54-1.2-1.2V4.9zm6.5 6.1c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/>
                        </svg>
                    </button>
                    <button 
                        id="nmims-chat-send" 
                        class="nmims-chat-send w-11 h-11 bg-[#D2232A] text-white rounded-full flex items-center justify-center flex-shrink-0 transition-all duration-300 hover:bg-[#a81c22] disabled:opacity-50 disabled:cursor-not-allowed"
                        aria-label="Send message"
                    >
                        <svg class="w-5 h-5" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="nmims-source-viewer" class="nmims-source-viewer fixed inset-0 bg-black bg-opacity-70 z-50 items-center justify-center p-4 hidden" aria-hidden="true">
        <div class="nmims-source-viewer-content bg-white p-6 rounded-lg max-w-3xl w-full max-h-[80vh] overflow-y-auto relative">
            <button class="nmims-source-viewer-close absolute top-3 right-3 w-8 h-8 bg-[#D2232A] text-white rounded-full text-lg font-bold flex items-center justify-center" aria-label="Close source viewer">&times;</button>
            <div id="nmims-source-viewer-body" class="mt-4 pr-4">
                </div>
        </div>
    </div>

    <script>
        // ========================================
        // CONFIGURATION
        // ========================================
        const CONFIG = {
            apiBase: 'http://localhost:8086/api',
            sessionId: 'hack-demo',
            authToken: null,
            logoSmall: "{{ url_for('static', filename='media/logo.png') }}",
            logoLarge: "{{ url_for('static', filename='media/logo.png') }}",
            mockMode: false,
            quickReplies: [
                "What are the key academic calendar deadlines?",
                "What is the NMIMS Ragging policy?",
                "What is the minimum attendance required for a student to appear in the exams?",
                "What are the fees and refund rules?",
                "How do I apply for an official transcript?",
                "What is the grading policy for UG programs?",
            ]
        };

        // ========================================
        // STATE MANAGEMENT
        // ========================================
        const state = {
            isOpen: false,
            messages: [],
            queryCache: new Map(),
            currentUserId: null,
            focusTrap: null,
            // --- NEW: MediaRecorder (MIC FIX) ---
            mediaRecorder: null,
            audioChunks: [],
            isRecording: false,
            audioStream: null
            // ------------------------------------
        };

        // ========================================
        // DOM ELEMENTS
        // ========================================
        const elements = {
            button: document.getElementById('nmims-chat-button'),
            buttonLogo: document.getElementById('nmims-button-logo'),
            buttonIcon: document.getElementById('nmims-button-icon'),
            overlay: document.getElementById('nmims-chat-overlay'),
            modal: document.querySelector('.nmims-chat-modal'),
            headerLogo: document.getElementById('nmims-header-logo'),
            closeBtn: document.getElementById('nmims-chat-close'),
            langSelect: document.getElementById('nmims-lang-select'), // <-- NEW
            messagesContainer: document.getElementById('nmims-chat-messages'),
            input: document.getElementById('nmims-chat-input'),
            sendBtn: document.getElementById('nmims-chat-send'),
            micBtn: document.getElementById('nmims-chat-mic'), // <-- NEW
            sourceViewer: document.getElementById('nmims-source-viewer'),
            sourceViewerBody: document.getElementById('nmims-source-viewer-body')
        };

        // ========================================
        // INITIALIZATION
        // ========================================
        function init() {
            loadLogo(elements.buttonLogo, CONFIG.logoSmall, elements.buttonIcon);
            loadLogo(elements.headerLogo, CONFIG.logoLarge);
            
            // --- FIX 1: Do not load chat history ---
            // loadChatHistory(); 
            // ---------------------------------------

            elements.button.addEventListener('click', openModal);
            elements.button.addEventListener('keydown', handleButtonKeydown);
            elements.closeBtn.addEventListener('click', closeModal);
            elements.overlay.addEventListener('click', handleOverlayClick);
            elements.sendBtn.addEventListener('click', sendMessage);
            elements.input.addEventListener('keydown', handleInputKeydown);
            elements.input.addEventListener('input', autoResizeTextarea);
            
            // --- NEW: Add mic button listener ---
            elements.micBtn.addEventListener('click', toggleAudioRecording);
            // ------------------------------------

            elements.sourceViewer.querySelector('.nmims-source-viewer-close')
                .addEventListener('click', closeSourceViewer);

            if (state.messages.length === 0) {
                showWelcomeMessage();
            } else {
                renderMessages();
            }

            console.log('[NMIMS Chat] Widget initialized');
        }

        // ========================================
        // LOGO HANDLING
        // ========================================
        function loadLogo(imgElement, src, iconElement = null) {
            if (!src) return; 
            imgElement.src = src;
            imgElement.onload = () => {
                imgElement.style.display = 'block';
                if (iconElement) {
                    iconElement.style.display = 'none';
                }
            };
            imgElement.onerror = () => {
                console.warn('[NMIMS Chat] Logo not found:', src);
                imgElement.style.display = 'none';
                if (iconElement) {
                    iconElement.style.display = 'block';
                }
            };
        }

        // ========================================
        // MODAL CONTROLS
        // ========================================
        function openModal() {
            state.isOpen = true;
            elements.overlay.classList.remove('hidden');
            elements.overlay.classList.add('flex');
            elements.overlay.setAttribute('aria-hidden', 'false');
            elements.input.focus();
            setupFocusTrap();
            console.log('[NMIMS Chat] Modal opened - keyboard accessible');
        }

        function closeModal() {
            state.isOpen = false;
            elements.overlay.classList.add('hidden');
            elements.overlay.classList.remove('flex');
            elements.overlay.setAttribute('aria-hidden', 'true');
            elements.button.focus();
            removeFocusTrap();
            console.log('[NMIMS Chat] Modal closed');
        }

        function handleOverlayClick(e) {
            if (e.target === elements.overlay) {
                closeModal();
            }
        }

        function handleButtonKeydown(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                openModal();
            }
        }

        // ========================================
        // FOCUS TRAP (Accessibility)
        // ========================================
        function setupFocusTrap() {
            document.addEventListener('keydown', handleFocusTrap);
        }

        function removeFocusTrap() {
            document.removeEventListener('keydown', handleFocusTrap);
        }

        function handleFocusTrap(e) {
            if (!state.isOpen) return;
            if (e.key === 'Escape') {
                closeModal();
                return;
            }
            if (e.key !== 'Tab') return;

            const focusableElements = Array.from(elements.modal.querySelectorAll(
                'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
            )).filter(el => el.offsetParent !== null); 

            if (focusableElements.length === 0) return;

            const firstElement = focusableElements[0];
            const lastElement = focusableElements[focusableElements.length - 1];

            if (e.shiftKey) {
                if (document.activeElement === firstElement) {
                    lastElement.focus();
                    e.preventDefault();
                }
            } else {
                if (document.activeElement === lastElement) {
                    firstElement.focus();
                    e.preventDefault();
                }
            }
        }

        // ========================================
        // WELCOME MESSAGE & QUICK REPLIES
        // ========================================
        function showWelcomeMessage() {
            const welcomeMsg = {
                type: 'bot',
                text: 'Hello! I\'m NMIMS Campus Assistant. How can I help you today?',
                timestamp: new Date().toISOString(),
                showQuickReplies: true
            };
            state.messages.push(welcomeMsg);
            // --- FIX 1: Do not save history ---
            // saveChatHistory();
            // ----------------------------------
            renderMessages();
        }

        function renderQuickReplies() {
            const container = document.createElement('div');
            container.className = 'nmims-quick-replies flex flex-wrap gap-2 mt-3';
            
            CONFIG.quickReplies.forEach(reply => {
                const btn = document.createElement('button');
                btn.className = 'nmims-quick-reply bg-white border border-[#D2232A] text-[#D2232A] py-2 px-4 rounded-full text-sm cursor-pointer transition-all duration-200 hover:bg-[#D2232A] hover:text-white focus:outline-none focus:ring-2 focus:ring-red-300';
                btn.textContent = reply;
                btn.setAttribute('tabindex', '0');
                btn.addEventListener('click', () => handleQuickReply(reply));
                btn.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        handleQuickReply(reply);
                    }
                });
                container.appendChild(btn);
            });
            return container;
        }

        function handleQuickReply(text) {
            elements.input.value = text;
            sendMessage();
            console.log('[NMIMS Chat] Quick reply sent:', text);
            
            // --- FIX 3: Do not remove quick replies ---
            // (Logic removed)
            // ------------------------------------------
        }

        // ========================================
        // MESSAGE RENDERING
        // ========================================
        function renderMessages() {
            elements.messagesContainer.innerHTML = '';
            
            state.messages.forEach((msg, index) => {
                const msgElement = createMessageElement(msg);
                elements.messagesContainer.appendChild(msgElement);

                // --- FIX 3: Check *last message only* for quick replies ---
                // This logic ensures replies only show with the *first* welcome message
                // and not after every single bot message.
                if (index === 0 && msg.type === 'bot' && state.messages.length === 1) {
                     elements.messagesContainer.appendChild(renderQuickReplies());
                }
                // --------------------------------------------------------
            });

            scrollToBottom();
        }
        
        function escapeHTML(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
        }

        function simpleMarkdown(text) {
            let html = escapeHTML(text);
            // Bold: **text**
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            // Lists: - item or * item
            html = html.replace(/^\s*[\-\*]\s+(.*)$/gm, '<ul class="list-disc list-outside pl-5"><li>$1</li></ul>');
            html = html.replace(/<\/ul>\s*<ul class="list-disc list-outside pl-5">/g, '');
            // Numbered lists: 1. item
            html = html.replace(/^\s*\d+\.\s+(.*)$/gm, '<ol class="list-decimal list-outside pl-5"><li>$1</li></ol>');
            html = html.replace(/<\/ol>\s*<ol class="list-decimal list-outside pl-5">/g, '');
            // Citations: [Page X]
            html = html.replace(/\[(Page\s\d+)\]/g, '<span class="text-xs text-gray-500 ml-1">[$1]</span>');
            // Newlines
            html = html.replace(/\n/g, '<br>');
            return html;
        }

        function createMessageElement(msg) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `nmims-message flex flex-col animate-fade-in ${msg.type === 'user' ? 'items-end' : 'items-start'}`;

            const bubble = document.createElement('div');
            bubble.className = 'nmims-message-bubble max-w-[85%] sm:max-w-[80%] py-2.5 px-4 rounded-2xl text-sm leading-relaxed';

            if (msg.type === 'typing') {
                bubble.classList.add('bg-gray-200');
                bubble.innerHTML = `
                    <div class="nmims-typing flex gap-1.5 p-2.5">
                        <div class="nmims-typing-dot w-2 h-2 rounded-full bg-gray-500 animate-bounce" style="animation-delay: 0s;"></div>
                        <div class="nmims-typing-dot w-2 h-2 rounded-full bg-gray-500 animate-bounce" style="animation-delay: 0.1s;"></div>
                        <div class="nmims-typing-dot w-2 h-2 rounded-full bg-gray-500 animate-bounce" style="animation-delay: 0.2s;"></div>
                    </div>
                    <style>
                        @keyframes bounce { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-6px); } }
                        .animate-bounce { animation: bounce 1.2s infinite ease-in-out; }
                    </style>
                `;
            } else if (msg.type === 'error') {
                bubble.classList.add('bg-red-100', 'border', 'border-red-300', 'text-red-800');
                bubble.innerHTML = `
                    <div class="nmims-error font-medium">${escapeHTML(msg.text)}</div>
                    ${msg.retryQuery ? `<button class="nmims-retry-button mt-2 bg-[#D2232A] text-white py-1.5 px-3 rounded-md text-xs font-semibold hover:bg-[#a81c22]" onclick="retryQuery('${escapeHTML(msg.retryQuery)}')">Try again</button>` : ''}
                    ${msg.offlineMode ? `<div class="mt-2"><a href="mailto:support@nmims.edu?subject=Campus Assistant Query&body=${encodeURIComponent(msg.retryQuery || '')}" class="text-[#D2232A] underline font-semibold text-xs">Send via email</a></div>` : ''}
                `;
            } else {
                if (msg.type === 'user') {
                    bubble.classList.add('bg-[#D2232A]', 'text-white', 'rounded-br-lg');
                    bubble.textContent = msg.text;
                } else {
                    bubble.classList.add('bg-white', 'text-gray-800', 'rounded-bl-lg', 'border', 'border-gray-200');
                    bubble.innerHTML = simpleMarkdown(msg.text);
                }

                // Low confidence badge
                if (msg.confidence && msg.confidence < 0.6) {
                    const badge = document.createElement('div');
                    badge.className = 'nmims-confidence-badge mt-2 inline-block bg-yellow-100 text-yellow-800 border border-yellow-300 px-2 py-0.5 rounded-full text-xs font-medium';
                    badge.textContent = '‚ö†Ô∏è Low confidence answer';
                    bubble.appendChild(badge);
                }

                // Sources
                if (msg.sources && msg.sources.length > 0) {
                    bubble.appendChild(createSourcesElement(msg.sources, msg.request_id));
                }

                // Feedback
                if (msg.type === 'bot' && msg.request_id) {
                    bubble.appendChild(createFeedbackElement(msg.request_id));
                }
            }

            messageDiv.appendChild(bubble);

            // Timestamp
            if (msg.timestamp && msg.type !== 'typing') {
                const time = document.createElement('div');
                time.className = 'nmims-message-time text-xs text-gray-400 mt-1 px-2';
                time.textContent = formatTime(msg.timestamp);
                messageDiv.appendChild(time);
            }

            return messageDiv;
        }

        function createSourcesElement(sources, requestId) {
            const container = document.createElement('div');
            container.className = 'nmims-sources mt-3 pt-3 border-t border-gray-200';

            const title = document.createElement('div');
            title.className = 'nmims-sources-title text-xs font-semibold text-gray-500 mb-2';
            title.textContent = 'üìö Sources:';
            container.appendChild(title);

            const list = document.createElement('div');
            list.className = 'space-y-1.5';
            
            sources.forEach((source, index) => {
                const item = document.createElement('div');
                item.className = 'nmims-source-item flex justify-between items-center bg-gray-50 p-2 rounded';

                const info = document.createElement('div');
                info.className = 'nmims-source-info text-xs text-gray-600 truncate pr-2';
                info.textContent = `${source.file} | p.${source.page}`;
                info.title = `${source.file} | p.${source.page}`;
                item.appendChild(info);

                const btn = document.createElement('button');
                btn.className = 'nmims-source-button bg-[#D2232A] text-white py-1 px-2.5 rounded text-xs font-medium transition-colors hover:bg-[#a81c22] focus:outline-none focus:ring-2 focus:ring-red-300';
                btn.textContent = 'View';
                const sourceId = `${requestId}-source-${index}`;
                btn.addEventListener('click', () => openSource(source.file, source.page, sourceId));
                item.appendChild(btn);

                list.appendChild(item);
            });
            container.appendChild(list);
            return container;
        }

        function createFeedbackElement(requestId) {
            const container = document.createElement('div');
            container.className = 'nmims-feedback mt-2.5 flex gap-2 items-center';
            container.id = `feedback-${requestId}`;

            const thumbsUp = document.createElement('button');
            thumbsUp.className = 'nmims-feedback-button w-8 h-8 rounded-full border border-gray-300 bg-white text-base flex items-center justify-center cursor-pointer transition-all hover:bg-gray-100 hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-red-300';
            thumbsUp.innerHTML = 'üëç';
            thumbsUp.setAttribute('aria-label', 'Helpful');
            thumbsUp.addEventListener('click', (e) => handleFeedback(requestId, 'up', container, e.currentTarget));

            const thumbsDown = document.createElement('button');
            thumbsDown.className = 'nmims-feedback-button w-8 h-8 rounded-full border border-gray-300 bg-white text-base flex items-center justify-center cursor-pointer transition-all hover:bg-gray-100 hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-red-300';
            thumbsDown.innerHTML = 'üëé';
            thumbsDown.setAttribute('aria-label', 'Not helpful');
            thumbsDown.addEventListener('click', (e) => handleFeedback(requestId, 'down', container, e.currentTarget));

            container.appendChild(thumbsUp);
            container.appendChild(thumbsDown);

            return container;
        }

        // ========================================
        // SEND MESSAGE
        // ========================================
        function sendMessage() {
            const query = elements.input.value.trim();
            if (!query) return;

            // --- FIX 3: Do not remove quick replies ---
            // (logic removed)
            // ------------------------------------------

            const userMsg = {
                type: 'user',
                text: query,
                timestamp: new Date().toISOString()
            };
            state.messages.push(userMsg);
            
            // --- FIX 1: Do not save history ---
            // saveChatHistory();
            // ----------------------------------
            
            renderMessages();

            elements.input.value = '';
            autoResizeTextarea();

            sendQuery(query);
            console.log('[NMIMS Chat] Message sent:', query);
        }

        function handleInputKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function autoResizeTextarea() {
            elements.input.style.height = 'auto'; // Reset height
            elements.input.style.height = Math.min(elements.input.scrollHeight, 100) + 'px';
        }

        // ========================================
        // QUERY BACKEND
        // ========================================
        async function sendQuery(query) {
            const cached = state.queryCache.get(query);
            if (cached && (Date.now() - cached.timestamp < 600000)) {
                console.log('[NMIMS Chat] Using cached response');
                handleQueryResponse(cached.response, query);
                return;
            }

            const typingMsg = { type: 'typing', timestamp: new Date().toISOString() };
            state.messages.push(typingMsg);
            renderMessages();
            elements.sendBtn.disabled = true;
            elements.micBtn.disabled = true; // <-- NEW: Disable mic during response

            try {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 30000); // 30 seconds for Bedrock LLM 

                const headers = { 'Content-Type': 'application/json' };
                if (CONFIG.authToken) {
                    headers['Authorization'] = CONFIG.authToken;
                }
                
                // --- NEW: Get language from dropdown ---
                const selectedLang = elements.langSelect.value || 'en';
                // -------------------------------------

                const apiResponse = await fetch(`${CONFIG.apiBase}/chat`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        session_id: CONFIG.sessionId,
                        user_id: state.currentUserId,
                        query: query,
                        language: selectedLang // <-- NEW: Send language to backend
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeout);
                elements.sendBtn.disabled = false;
                elements.micBtn.disabled = false; // <-- NEW: Re-enable mic

                if (!apiResponse.ok) {
                    throw new Error(`API error: ${apiResponse.status}`);
                }

                const response = await apiResponse.json();

                state.messages = state.messages.filter(m => m.type !== 'typing');
                state.queryCache.set(query, { response: response, timestamp: Date.now() });
                handleQueryResponse(response, query);

            } catch (error) {
                console.error('[NMIMS Chat] Query error:', error);
                elements.sendBtn.disabled = false;
                elements.micBtn.disabled = false; // <-- NEW: Re-enable mic
                state.messages = state.messages.filter(m => m.type !== 'typing');

                // Better error detection: only treat as offline if actually offline, not on timeout
                const isActuallyOffline = !navigator.onLine;
                const isTimeout = error.name === 'AbortError';
                
                let errorText;
                if (isActuallyOffline) {
                    errorText = 'üîå You appear to be offline. Your question has been saved.';
                } else if (isTimeout) {
                    errorText = '‚è±Ô∏è The request timed out. The server might be busy. Please try again.';
                } else {
                    errorText = '‚ùå Sorry, something went wrong. Please try again.';
                }
                
                const errorMsg = {
                    type: 'error',
                    text: errorText,
                    timestamp: new Date().toISOString(),
                    retryQuery: query,
                    offlineMode: isActuallyOffline
                };
                state.messages.push(errorMsg);
                
                // --- FIX 1: Do not save history ---
                // saveChatHistory();
                // ----------------------------------
                
                renderMessages();
            }
        }

        function handleQueryResponse(response, originalQuery) {
            const botMsg = {
                type: 'bot',
                text: response.answer,
                timestamp: new Date().toISOString(),
                sources: response.sources || [],
                confidence: response.confidence,
                request_id: response.request_id || generateRequestId()
            };

            // This logic is now handled on the backend based on confidence/sources
            // if (response.confidence < 0.6 || (response.sources.length === 0 && isPolicyQuestion(originalQuery))) {
            //     botMsg.text += "\n\n‚ö†Ô∏è I'm not entirely sure about this answer. For accurate information, please contact Student Affairs: studentaffairs@nmims.edu";
            // }

            state.messages.push(botMsg);
            
            // --- FIX 1: Do not save history ---
            // saveChatHistory();
            // ----------------------------------
            
            renderMessages();

            console.log('[NMIMS Chat] Response received, confidence:', response.confidence);
        }

        function isPolicyQuestion(query) {
            const policyKeywords = ['rule', 'policy', 'allowed', 'can i', 'permission', 'guideline', 'regulation'];
            const lowerQuery = query.toLowerCase();
            return policyKeywords.some(keyword => lowerQuery.includes(keyword));
        }

        function generateRequestId() {
            return 'req_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // ========================================
        // --- NEW: SPEECH RECOGNITION (MediaRecorder FIX) ---
        // ========================================
        
        async function toggleAudioRecording() {
            if (state.isRecording) {
                // --- STOP RECORDING ---
                try {
                    state.mediaRecorder.stop(); // This will trigger the 'onstop' event
                    state.isRecording = false;
                    // UI will be reset in 'onstop'
                } catch (e) {
                    console.error("Error stopping recorder:", e);
                    resetMicButton();
                }
                
            } else {
                // --- START RECORDING ---
                try {
                    // 1. Get permissions
                    state.audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    
                    // 2. Create recorder
                    state.mediaRecorder = new MediaRecorder(state.audioStream);
                    state.audioChunks = []; // Clear previous chunks
                    
                    // 3. Set up event handlers
                    state.mediaRecorder.ondataavailable = (event) => {
                        state.audioChunks.push(event.data);
                    };
                    
                    state.mediaRecorder.onstop = () => {
                        console.log("Recording stopped, processing audio...");
                        // Stop the microphone track
                        if (state.audioStream) {
                            state.audioStream.getTracks().forEach(track => track.stop());
                            state.audioStream = null;
                        }
                        
                        // Convert audio chunks to a single Blob
                        const audioBlob = new Blob(state.audioChunks, { type: 'audio/webm' });
                        
                        // Convert Blob to Base64 to send as JSON
                        const reader = new FileReader();
                        reader.readAsDataURL(audioBlob);
                        reader.onloadend = () => {
                            const base64AudioData = reader.result;
                            transcribeAudio(base64AudioData);
                        };
                        
                        resetMicButton();
                    };

                    // 4. Start recording
                    state.mediaRecorder.start();
                    state.isRecording = true;
                    
                    // 5. Update UI
                    elements.micBtn.classList.add('mic-active', 'bg-red-500', 'text-white');
                    elements.micBtn.setAttribute('aria-label', 'Stop listening');
                    elements.input.placeholder = "Listening... Click mic to stop";

                } catch (err) {
                    console.error("Error starting recording:", err);
                    if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                        alert('Microphone permission denied. Please allow microphone access in your browser settings.');
                    } else {
                        alert('Could not start recorder. Is a microphone connected?');
                    }
                    resetMicButton();
                }
            }
        }

        async function transcribeAudio(base64AudioData) {
            elements.input.placeholder = "Transcribing audio...";
            elements.micBtn.disabled = true;
            elements.sendBtn.disabled = true;

            try {
                const response = await fetch(`${CONFIG.apiBase}/transcribe`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        audio_data: base64AudioData
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Transcription failed');
                }

                const data = await response.json();
                
                if (data.transcript) {
                    elements.input.value = data.transcript;
                    autoResizeTextarea();
                    sendMessage(); // Automatically send the transcribed text
                } else {
                    elements.input.placeholder = "Could not understand audio.";
                }

            } catch (error) {
                console.error("Transcription error:", error);
                alert(`Transcription failed: ${error.message}`);
                elements.input.placeholder = "Ask me anything about campus...";
            } finally {
                elements.micBtn.disabled = false;
                elements.sendBtn.disabled = false;
            }
        }
        
        function resetMicButton() {
            state.isRecording = false;
            if (state.audioStream) {
                state.audioStream.getTracks().forEach(track => track.stop());
                state.audioStream = null;
            }
            state.mediaRecorder = null;
            state.audioChunks = [];
            
            elements.micBtn.classList.remove('mic-active', 'bg-red-500', 'text-white');
            elements.micBtn.setAttribute('aria-label', 'Start voice input');
            elements.input.placeholder = "Ask me anything about campus...";
        }
        // ------------------------------------

        // ========================================
        // RETRY QUERY
        // ========================================
        window.retryQuery = function(query) {
            const unescapedQuery = query.replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/>/g, '>').replace(/"/g, '"').replace(/'/g, '&#039;');
            elements.input.value = unescapedQuery;
            sendMessage();
        };

        // ========================================
        // OPEN SOURCE
        // ========================================
        async function openSource(fileId, page, sourceId) {
            console.log('[NMIMS Chat] Opening source:', fileId, 'page', page);

            try {
                const headers = {};
                if (CONFIG.authToken) {
                    headers['Authorization'] = CONFIG.authToken;
                }

                const response = await fetch(
                    `${CONFIG.apiBase}/sources?file_id=${encodeURIComponent(fileId)}&page=${page}`,
                    { headers }
                );

                if (!response.ok) {
                    throw new Error(`Failed to fetch source: ${response.status}`);
                }

                const data = await response.json();

                if (data.snippet) {
                    elements.sourceViewerBody.innerHTML = `
                        <h3 class="text-lg font-semibold text-gray-800">${escapeHTML(fileId)} - Page ${page}</h3>
                        <pre class="whitespace-pre-wrap text-sm text-gray-700 leading-relaxed bg-gray-50 p-3 rounded-md mt-2">${escapeHTML(data.snippet)}</pre>
                    `;
                    elements.sourceViewer.classList.remove('hidden');
                    elements.sourceViewer.classList.add('flex');
                    elements.sourceViewer.setAttribute('aria-hidden', 'false');
                    elements.sourceViewer.querySelector('.nmims-source-viewer-close').focus();
                    console.log('[NMIMS Chat] Showing snippet in overlay viewer');
                } else {
                    alert('Source content not available');
                }

            } catch (error) {
                console.error('[NMIMS Chat] Error opening source:', error);
                alert('Failed to open source. Please try again.');
            }
        }

        function closeSourceViewer() {
            elements.sourceViewer.classList.add('hidden');
            elements.sourceViewer.classList.remove('flex');
            elements.sourceViewer.setAttribute('aria-hidden', 'true');
        }

        // ========================================
        // FEEDBACK
        // ========================================
        async function handleFeedback(requestId, rating, container, clickedButton) {
            const buttons = container.querySelectorAll('.nmims-feedback-button');
            buttons.forEach(btn => {
                btn.disabled = true;
                btn.classList.remove('bg-[#D2232A]', 'text-white'); // Remove active state
            });
            clickedButton.classList.add('bg-[#D2232A]', 'text-white', 'border-[#D2232A]'); // Set active state

            if (rating === 'down') {
                if (!container.querySelector('.nmims-feedback-comment')) {
                    const commentBox = document.createElement('textarea');
                    commentBox.className = 'nmims-feedback-comment w-full mt-2 p-2 border border-gray-300 rounded-md text-sm outline-none focus:ring-2 focus:ring-[#D2232A]';
                    commentBox.placeholder = 'What could be improved? (optional)';

                    const submitBtn = document.createElement('button');
                    submitBtn.className = 'nmims-feedback-submit mt-1.5 bg-[#D2232A] text-white py-1 px-3 rounded text-xs font-medium transition-colors hover:bg-[#a81c22]';
                    submitBtn.textContent = 'Submit feedback';
                    submitBtn.addEventListener('click', () => submitFeedback(requestId, rating, commentBox.value, container));

                    container.appendChild(commentBox);
                    container.appendChild(submitBtn);
                    commentBox.focus();
                }
            } else {
                submitFeedback(requestId, rating, '', container);
            }

            console.log('[NMIMS Chat] Feedback:', rating, 'for request', requestId);
        }

        async function submitFeedback(requestId, rating, comment, container) {
            try {
                const headers = { 'Content-Type': 'application/json' };
                if (CONFIG.authToken) {
                    headers['Authorization'] = CONFIG.authToken;
                }

                await fetch(`${CONFIG.apiBase}/feedback`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        request_id: requestId,
                        rating: rating,
                        comment: comment
                    })
                });

                const commentBox = container.querySelector('.nmims-feedback-comment');
                const submitBtn = container.querySelector('.nmims-feedback-submit');
                if (commentBox) commentBox.remove();
                if (submitBtn) submitBtn.remove();

                const thanks = document.createElement('span');
                thanks.className = 'text-xs text-gray-500 ml-2 font-medium';
                thanks.textContent = '‚úì Thank you!';
                container.appendChild(thanks);

                console.log('[NMIMS Chat] Feedback submitted successfully');

            } catch (error) {
                console.error('[NMIMS Chat] Error submitting feedback:', error);
                 const buttons = container.querySelectorAll('.nmims-feedback-button');
                 buttons.forEach(btn => btn.disabled = false);
            }
        }

        // ========================================
        // SESSION STORAGE (FIX 1: DISABLED)
        // ========================================
        function saveChatHistory() {
            // No-op
        }

        function loadChatHistory() {
            // No-op
        }

        // ========================================
        // UTILITIES
        // ========================================
        function scrollToBottom() {
            elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ========================================
        // START APPLICATION
        // ========================================
        init();

        console.log('[NMIMS Chat] Widget ready - accessibility features enabled');
    </script>

</body>
</html>